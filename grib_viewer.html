<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WX-Anal GRIB Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #fff;
            overflow: hidden;
        }
        
        #container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }
        
        /* Map Container */
        #map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Sidebar */
        #sidebar {
            width: 350px;
            background: #2a2a2a;
            border-left: 1px solid #444;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid #444;
        }
        
        .sidebar-section h3 {
            margin-bottom: 15px;
            color: #4a9eff;
            font-size: 1.1em;
        }
        
        /* Layer Controls */
        .layer-control {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .layer-control label {
            display: flex;
            align-items: center;
            cursor: pointer;
            flex: 1;
        }
        
        .layer-control input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .layer-control select {
            background: #1a1a1a;
            color: #fff;
            border: 1px solid #555;
            padding: 5px;
            border-radius: 4px;
            margin-left: 10px;
        }
        
        /* Timeline Controls */
        #timeline-controls {
            padding: 15px 20px;
            background: #1a1a1a;
            border-top: 1px solid #444;
        }
        
        #time-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #444;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4a9eff;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4a9eff;
            cursor: pointer;
            border: none;
        }
        
        #time-display {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9em;
            color: #aaa;
        }
        
        .play-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .play-controls button {
            flex: 1;
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
        }
        
        .play-controls button:hover {
            background: #3a8eef;
        }
        
        .play-controls button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        /* Color Scale Legend */
        .color-scale {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        
        .scale-bar {
            display: flex;
            height: 20px;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .scale-bar div {
            flex: 1;
        }
        
        .scale-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #aaa;
        }
        
        /* Info Panel */
        #info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(42, 42, 42, 0.95);
            padding: 15px 20px;
            border-radius: 8px;
            border: 1px solid #555;
            max-width: 300px;
            z-index: 1000;
        }
        
        #info-panel h4 {
            color: #4a9eff;
            margin-bottom: 10px;
            font-size: 1em;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .info-label {
            color: #aaa;
        }
        
        .info-value {
            color: #fff;
            font-weight: bold;
        }
        
        /* Top Bar */
        #top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 350px;
            background: rgba(42, 42, 42, 0.95);
            padding: 15px 20px;
            border-bottom: 1px solid #555;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #top-bar h1 {
            font-size: 1.5em;
            color: #4a9eff;
        }
        
        #top-bar .subtitle {
            font-size: 0.9em;
            color: #aaa;
        }
        
        /* Feature Overlays */
        .feature-marker {
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
            border: 2px solid #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .cutoff-low {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.9);
            color: white;
        }
        
        .high-pressure {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.9);
            color: white;
        }
        
        .route-line {
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        /* Confidence Indicator */
        #confidence-indicator {
            position: absolute;
            top: 80px;
            right: 370px;
            background: rgba(42, 42, 42, 0.95);
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #555;
            z-index: 1000;
        }
        
        .confidence-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .confidence-high {
            background: #22c55e;
            color: white;
        }
        
        .confidence-moderate {
            background: #fbbf24;
            color: #1a1a1a;
        }
        
        .confidence-low {
            background: #ef4444;
            color: white;
        }
        
        /* Loading Indicator */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(42, 42, 42, 0.95);
            padding: 30px 40px;
            border-radius: 10px;
            z-index: 2000;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #444;
            border-top: 4px solid #4a9eff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Scrollbar Styling */
        #sidebar::-webkit-scrollbar {
            width: 8px;
        }
        
        #sidebar::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        #sidebar::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        
        #sidebar::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- Map Container -->
        <div id="map-container">
            <div id="top-bar">
                <div>
                    <h1>üåä WX-Anal GRIB Viewer</h1>
                    <div class="subtitle">Professional Marine Weather Visualization</div>
                </div>
                <div id="confidence-indicator">
                    <span style="color: #aaa;">Forecast Confidence:</span>
                    <span class="confidence-badge confidence-moderate">MODERATE</span>
                </div>
            </div>
            
            <div id="loading" style="display: none;">
                <div class="spinner"></div>
                <div>Loading weather data...</div>
            </div>
            
            <div id="map"></div>
            
            <div id="info-panel">
                <h4>üìç Location Info</h4>
                <div class="info-item">
                    <span class="info-label">Position:</span>
                    <span class="info-value" id="info-position">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Wind:</span>
                    <span class="info-value" id="info-wind">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Waves:</span>
                    <span class="info-value" id="info-waves">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Pressure:</span>
                    <span class="info-value" id="info-pressure">--</span>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div id="sidebar">
            <!-- Weather Layers -->
            <div class="sidebar-section">
                <h3>Weather Layers</h3>
                
                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="layer-wind" checked>
                        Wind Speed & Direction
                    </label>
                </div>
                
                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="layer-waves">
                        Wave Height
                    </label>
                </div>
                
                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="layer-pressure">
                        Surface Pressure
                    </label>
                </div>
                
                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="layer-temperature">
                        Sea Surface Temperature
                    </label>
                </div>
                
                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="layer-clouds">
                        Cloud Cover
                    </label>
                </div>
            </div>
            
            <!-- WX-Anal Features -->
            <div class="sidebar-section">
                <h3>WX-Anal Features</h3>
                
                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="feature-cutoff" checked>
                        Cut-off Lows
                    </label>
                </div>
                
                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="feature-routes" checked>
                        Route Variants
                    </label>
                    <select id="route-select">
                        <option value="all">All Routes</option>
                        <option value="direct">Direct Only</option>
                        <option value="northern">Northern Only</option>
                        <option value="southern">Southern Only</option>
                    </select>
                </div>
                
                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="feature-comfort">
                        Comfort Zones
                    </label>
                </div>
                
                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="feature-gulfstream">
                        Gulf Stream
                    </label>
                </div>
            </div>
            
            <!-- Vessel Settings -->
            <div class="sidebar-section">
                <h3>Vessel Settings</h3>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #aaa;">Vessel Type:</label>
                    <select id="vessel-type" style="width: 100%; background: #1a1a1a; color: #fff; border: 1px solid #555; padding: 8px; border-radius: 4px;">
                        <option value="typical">Typical Cruising Boat (6-6.5 kt)</option>
                        <option value="slow">Slow Boat (5-5.5 kt)</option>
                        <option value="fast">Fast Boat (7-8.5 kt)</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #aaa;">Route:</label>
                    <select id="route-name" style="width: 100%; background: #1a1a1a; color: #fff; border: 1px solid #555; padding: 8px; border-radius: 4px;">
                        <option value="hampton-bermuda">Hampton ‚Üí Bermuda</option>
                        <option value="hampton-antigua">Hampton ‚Üí Antigua</option>
                        <option value="bermuda-antigua">Bermuda ‚Üí Antigua</option>
                        <option value="beaufort-bermuda">Beaufort ‚Üí Bermuda</option>
                    </select>
                </div>
            </div>
            
            <!-- Color Scale -->
            <div class="sidebar-section">
                <h3>Color Scale</h3>
                <div class="color-scale">
                    <div style="margin-bottom: 10px; font-size: 0.9em; color: #aaa;">Wind Speed (knots)</div>
                    <div class="scale-bar">
                        <div style="background: #4ade80;"></div>
                        <div style="background: #a3e635;"></div>
                        <div style="background: #fbbf24;"></div>
                        <div style="background: #f59e0b;"></div>
                        <div style="background: #ef4444;"></div>
                        <div style="background: #dc2626;"></div>
                        <div style="background: #991b1b;"></div>
                    </div>
                    <div class="scale-labels">
                        <span>0</span>
                        <span>10</span>
                        <span>20</span>
                        <span>30</span>
                        <span>40</span>
                        <span>50+</span>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Info -->
            <div class="sidebar-section" style="flex: 1;">
                <h3>Current Analysis</h3>
                <div id="analysis-info" style="font-size: 0.9em; line-height: 1.6; color: #aaa;">
                    <p><strong style="color: #fff;">Forecast Run:</strong> Demo Data</p>
                    <p><strong style="color: #fff;">Valid Time:</strong> <span id="valid-time">T+0h</span></p>
                    <p><strong style="color: #fff;">Confidence:</strong> MODERATE (47/100)</p>
                    <p style="margin-top: 10px;">80% of model runs show cut-off low. Some run-to-run variation (4 flip-flops).</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Timeline Controls -->
    <div id="timeline-controls">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div style="color: #aaa; font-size: 0.9em;">Timeline</div>
            <div id="current-time" style="color: #4a9eff; font-weight: bold; font-size: 1.1em;">T+0h</div>
        </div>
        <input type="range" id="time-slider" min="0" max="168" value="0" step="3">
        <div id="time-display">
            <span>Now</span>
            <span>+7 days</span>
        </div>
        <div class="play-controls">
            <button id="btn-play">‚ñ∂Ô∏è Play</button>
            <button id="btn-step-back">‚èÆÔ∏è -3h</button>
            <button id="btn-step-forward">+3h ‚è≠Ô∏è</button>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize Map
        const map = L.map('map', {
            center: [34.5, -70],
            zoom: 6,
            zoomControl: true,
            attributionControl: false
        });
        
        // Add base layer (Dark theme)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }).addTo(map);
        
        // State
        let currentTime = 0;
        let isPlaying = false;
        let playInterval = null;
        let weatherLayers = {};
        let featureLayers = {};
        
        // Initialize layers
        function initializeLayers() {
            // Example: Add route variants
            const routes = {
                'direct': {
                    coords: [[37.0, -76.3], [32.3, -64.8]],
                    color: '#3b82f6',
                    name: 'Direct'
                },
                'northern': {
                    coords: [[37.0, -76.3], [37.0, -78.3], [36.0, -70.0], [32.3, -64.8]],
                    color: '#10b981',
                    name: 'Northern'
                },
                'southern': {
                    coords: [[37.0, -76.3], [35.0, -76.3], [34.5, -72.0], [32.3, -64.8]],
                    color: '#f59e0b',
                    name: 'Southern'
                }
            };
            
            featureLayers.routes = {};
            Object.keys(routes).forEach(key => {
                const route = routes[key];
                const polyline = L.polyline(route.coords, {
                    color: route.color,
                    weight: 3,
                    opacity: 0.8
                }).addTo(map);
                
                // Add markers
                L.circleMarker(route.coords[0], {
                    radius: 6,
                    fillColor: route.color,
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 1
                }).bindPopup(`<b>Start</b><br>${route.name} Route`).addTo(map);
                
                L.circleMarker(route.coords[route.coords.length - 1], {
                    radius: 6,
                    fillColor: route.color,
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 1
                }).bindPopup(`<b>End</b><br>${route.name} Route`).addTo(map);
                
                featureLayers.routes[key] = polyline;
            });
            
            // Example: Add cut-off low marker
            const cutoffMarker = L.marker([30, -92], {
                icon: L.divIcon({
                    className: 'feature-marker cutoff-low',
                    html: 'üåÄ Cut-off Low',
                    iconSize: [120, 30]
                })
            }).bindPopup('<b>Cut-off Low</b><br>500 hPa vorticity max<br>Louisiana region').addTo(map);
            
            featureLayers.cutoff = cutoffMarker;
            
            // Add simulated wind barbs/arrows (simplified visualization)
            addWindVisualization();
        }
        
        function addWindVisualization() {
            // This would normally load actual GRIB data
            // For demo, show conceptual wind field
            const windPoints = [];
            for (let lat = 28; lat <= 38; lat += 2) {
                for (let lon = -78; lon <= -62; lon += 2) {
                    windPoints.push([lat, lon]);
                }
            }
            
            windPoints.forEach(([lat, lon]) => {
                // Simulate wind direction and speed
                const angle = Math.random() * 360;
                const speed = 10 + Math.random() * 20;
                
                const color = getWindColor(speed);
                
                L.circleMarker([lat, lon], {
                    radius: 3,
                    fillColor: color,
                    color: color,
                    weight: 1,
                    fillOpacity: 0.6
                }).bindPopup(`Wind: ${speed.toFixed(0)} kt<br>Direction: ${angle.toFixed(0)}¬∞`).addTo(map);
            });
        }
        
        function getWindColor(speed) {
            if (speed < 10) return '#4ade80';
            if (speed < 20) return '#a3e635';
            if (speed < 30) return '#fbbf24';
            if (speed < 40) return '#ef4444';
            return '#dc2626';
        }
        
        // Timeline controls
        document.getElementById('time-slider').addEventListener('input', (e) => {
            currentTime = parseInt(e.target.value);
            updateTime();
        });
        
        document.getElementById('btn-play').addEventListener('click', () => {
            if (isPlaying) {
                stopAnimation();
            } else {
                startAnimation();
            }
        });
        
        document.getElementById('btn-step-back').addEventListener('click', () => {
            currentTime = Math.max(0, currentTime - 3);
            document.getElementById('time-slider').value = currentTime;
            updateTime();
        });
        
        document.getElementById('btn-step-forward').addEventListener('click', () => {
            currentTime = Math.min(168, currentTime + 3);
            document.getElementById('time-slider').value = currentTime;
            updateTime();
        });
        
        function startAnimation() {
            isPlaying = true;
            document.getElementById('btn-play').textContent = '‚è∏Ô∏è Pause';
            
            playInterval = setInterval(() => {
                currentTime += 3;
                if (currentTime > 168) {
                    currentTime = 0;
                }
                document.getElementById('time-slider').value = currentTime;
                updateTime();
            }, 500); // Update every 500ms
        }
        
        function stopAnimation() {
            isPlaying = false;
            document.getElementById('btn-play').textContent = '‚ñ∂Ô∏è Play';
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
        }
        
        function updateTime() {
            document.getElementById('current-time').textContent = `T+${currentTime}h`;
            document.getElementById('valid-time').textContent = `T+${currentTime}h`;
            
            // In real implementation, this would update weather data visualization
            // For now, just update info panel with simulated data
            updateInfoPanel();
        }
        
        function updateInfoPanel() {
            // Simulate data changes with time
            const windSpeed = 15 + Math.sin(currentTime / 20) * 10;
            const waveHeight = 2 + Math.cos(currentTime / 15) * 1.5;
            const pressure = 1013 + Math.sin(currentTime / 30) * 10;
            
            document.getElementById('info-wind').textContent = `${windSpeed.toFixed(1)} kt`;
            document.getElementById('info-waves').textContent = `${waveHeight.toFixed(1)} m`;
            document.getElementById('info-pressure').textContent = `${pressure.toFixed(0)} mb`;
        }
        
        // Layer controls
        document.getElementById('layer-wind').addEventListener('change', (e) => {
            // Toggle wind layer
            console.log('Wind layer:', e.target.checked);
        });
        
        document.getElementById('feature-routes').addEventListener('change', (e) => {
            Object.values(featureLayers.routes).forEach(layer => {
                if (e.target.checked) {
                    layer.addTo(map);
                } else {
                    map.removeLayer(layer);
                }
            });
        });
        
        document.getElementById('feature-cutoff').addEventListener('change', (e) => {
            if (e.target.checked) {
                featureLayers.cutoff.addTo(map);
            } else {
                map.removeLayer(featureLayers.cutoff);
            }
        });
        
        // Map click handler
        map.on('click', (e) => {
            document.getElementById('info-position').textContent = 
                `${e.latlng.lat.toFixed(2)}¬∞N, ${Math.abs(e.latlng.lng).toFixed(2)}¬∞W`;
        });
        
        // Initialize
        initializeLayers();
        updateTime();
        
        // Load analysis data if available
        fetch('demo_analysis_output.json')
            .then(response => response.json())
            .then(data => {
                console.log('Analysis data loaded:', data);
                // Update UI with actual analysis data
            })
            .catch(error => {
                console.log('Using demo mode:', error);
            });
    </script>
</body>
</html>
